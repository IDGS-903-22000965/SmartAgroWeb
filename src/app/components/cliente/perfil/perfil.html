<!-- src/app/components/cliente/perfil/perfil.html -->
<div class="perfil">
  <!-- Header -->
  <div class="page-header">
    <h1>ğŸ‘¤ Mi Perfil</h1>
    <p>Administra tu informaciÃ³n personal y configuraciÃ³n de cuenta</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingProfile" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loadingProfile" class="error-container">
    <div class="error-message">
      <h3>âš ï¸ Error</h3>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadProfile()">
        Reintentar
      </button>
    </div>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!loadingProfile && !error && currentUser" class="profile-content">
    
    <!-- Success Messages -->
    <div *ngIf="success" class="success-message">
      <h4>âœ… Â¡Perfil actualizado exitosamente!</h4>
    </div>

    <div *ngIf="passwordSuccess" class="success-message">
      <h4>âœ… Â¡ContraseÃ±a cambiada exitosamente!</h4>
    </div>

    <!-- Profile Info Card -->
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar">
          <span class="avatar-text">{{ currentUser.nombre.charAt(0) }}{{ currentUser.apellidos.charAt(0) }}</span>
        </div>
        <div class="profile-basic-info">
          <h2>{{ currentUser.nombreCompleto }}</h2>
          <p class="user-email">{{ currentUser.email }}</p>
          <div class="user-meta">
            <span class="meta-item">
              ğŸ“… Miembro desde {{ formatDate(currentUser.fechaRegistro) }}
            </span>
            <span class="meta-item" [ngClass]="currentUser.activo ? 'status-active' : 'status-inactive'">
              {{ currentUser.activo ? 'ğŸŸ¢ Activo' : 'ğŸ”´ Inactivo' }}
            </span>
          </div>
        </div>
        <div class="profile-actions">
          <button 
            *ngIf="!editMode && !changePasswordMode" 
            class="btn btn-primary" 
            (click)="toggleEditMode()"
          >
            âœï¸ Editar Perfil
          </button>
          <button 
            *ngIf="!editMode && !changePasswordMode" 
            class="btn btn-secondary" 
            (click)="toggleChangePasswordMode()"
          >
            ğŸ”’ Cambiar ContraseÃ±a
          </button>
          <button 
            class="btn btn-outline logout-btn" 
            (click)="logout()"
          >
            ğŸšª Cerrar SesiÃ³n
          </button>
        </div>
      </div>

      <!-- Edit Profile Form -->
      <div *ngIf="editMode" class="edit-form">
        <h3>âœï¸ Editar InformaciÃ³n Personal</h3>
        
        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
          <div class="form-grid">
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input 
                id="nombre"
                type="text" 
                formControlName="nombre"
                class="form-input"
                [class.invalid]="isFieldInvalid('nombre')"
                placeholder="Ingresa tu nombre"
              >
              <div *ngIf="getFieldError('nombre')" class="field-error">
                {{ getFieldError('nombre') }}
              </div>
            </div>

            <div class="form-group">
              <label for="apellidos">Apellidos *</label>
              <input 
                id="apellidos"
                type="text" 
                formControlName="apellidos"
                class="form-input"
                [class.invalid]="isFieldInvalid('apellidos')"
                placeholder="Ingresa tus apellidos"
              >
              <div *ngIf="getFieldError('apellidos')" class="field-error">
                {{ getFieldError('apellidos') }}
              </div>
            </div>

            <div class="form-group full-width">
              <label for="email">Email *</label>
              <input 
                id="email"
                type="email" 
                formControlName="email"
                class="form-input"
                [class.invalid]="isFieldInvalid('email')"
                placeholder="tu@email.com"
              >
              <div *ngIf="getFieldError('email')" class="field-error">
                {{ getFieldError('email') }}
              </div>
            </div>

            <div class="form-group">
              <label for="telefono">TelÃ©fono</label>
              <input 
                id="telefono"
                type="tel" 
                formControlName="telefono"
                class="form-input"
                [class.invalid]="isFieldInvalid('telefono')"
                placeholder="1234567890"
                maxlength="10"
              >
              <div *ngIf="getFieldError('telefono')" class="field-error">
                {{ getFieldError('telefono') }}
              </div>
            </div>

            <div class="form-group">
              <label for="direccion">DirecciÃ³n</label>
              <input 
                id="direccion"
                type="text" 
                formControlName="direccion"
                class="form-input"
                placeholder="Tu direcciÃ³n completa"
              >
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="toggleEditMode()"
              [disabled]="loading"
            >
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!profileForm.valid || loading"
            >
              <span *ngIf="loading">Guardando...</span>
              <span *ngIf="!loading">ğŸ’¾ Guardar Cambios</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Change Password Form -->
      <div *ngIf="changePasswordMode" class="password-form">
        <h3>ğŸ”’ Cambiar ContraseÃ±a</h3>
        
        <div *ngIf="passwordError" class="password-error">
          <p>{{ passwordError }}</p>
        </div>

        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
          <div class="form-group">
            <label for="currentPassword">ContraseÃ±a Actual *</label>
            <input 
              id="currentPassword"
              type="password" 
              formControlName="currentPassword"
              class="form-input"
              [class.invalid]="isFieldInvalid('currentPassword', passwordForm)"
              placeholder="Tu contraseÃ±a actual"
            >
            <div *ngIf="getFieldError('currentPassword', passwordForm)" class="field-error">
              {{ getFieldError('currentPassword', passwordForm) }}
            </div>
          </div>

          <div class="form-group">
            <label for="newPassword">Nueva ContraseÃ±a *</label>
            <input 
              id="newPassword"
              type="password" 
              formControlName="newPassword"
              class="form-input"
              [class.invalid]="isFieldInvalid('newPassword', passwordForm)"
              placeholder="Tu nueva contraseÃ±a (mÃ­nimo 6 caracteres)"
            >
            <div *ngIf="getFieldError('newPassword', passwordForm)" class="field-error">
              {{ getFieldError('newPassword', passwordForm) }}
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar Nueva ContraseÃ±a *</label>
            <input 
              id="confirmPassword"
              type="password" 
              formControlName="confirmPassword"
              class="form-input"
              [class.invalid]="isFieldInvalid('confirmPassword', passwordForm) || getPasswordFormError()"
              placeholder="Confirma tu nueva contraseÃ±a"
            >
            <div *ngIf="getFieldError('confirmPassword', passwordForm)" class="field-error">
              {{ getFieldError('confirmPassword', passwordForm) }}
            </div>
            <div *ngIf="getPasswordFormError()" class="field-error">
              {{ getPasswordFormError() }}
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="toggleChangePasswordMode()"
              [disabled]="loadingPassword"
            >
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!passwordForm.valid || loadingPassword"
            >
              <span *ngIf="loadingPassword">Cambiando...</span>
              <span *ngIf="!loadingPassword">ğŸ” Cambiar ContraseÃ±a</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Profile Details (Read Only) -->
      <div *ngIf="!editMode && !changePasswordMode" class="profile-details">
        <h3>ğŸ“‹ InformaciÃ³n Personal</h3>
        
        <div class="details-grid">
          <div class="detail-item">
            <strong>Nombre Completo:</strong>
            <span>{{ currentUser.nombreCompleto }}</span>
          </div>
          
          <div class="detail-item">
            <strong>Email:</strong>
            <span>{{ currentUser.email }}</span>
          </div>
          
          <div class="detail-item">
            <strong>TelÃ©fono:</strong>
            <span>{{ currentUser.telefono || 'No especificado' }}</span>
          </div>
          
          <div class="detail-item">
            <strong>DirecciÃ³n:</strong>
            <span>{{ currentUser.direccion || 'No especificada' }}</span>
          </div>
          
          <div class="detail-item">
            <strong>Fecha de Registro:</strong>
            <span>{{ formatDate(currentUser.fechaRegistro) }}</span>
          </div>
          
          <div class="detail-item">
            <strong>Roles:</strong>
            <div class="roles-list">
              <span 
                *ngFor="let role of currentUser.roles" 
                class="role-badge"
              >
                {{ role }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Security Section -->
    <div *ngIf="!editMode && !changePasswordMode" class="security-section">
      <h3>ğŸ›¡ï¸ Seguridad de la Cuenta</h3>
      
      <div class="security-items">
        <div class="security-item">
          <div class="security-icon">ğŸ”</div>
          <div class="security-content">
            <h4>ContraseÃ±a</h4>
            <p>Ãšltima actualizaciÃ³n hace tiempo</p>
          </div>
          <button class="btn btn-outline" (click)="toggleChangePasswordMode()">
            Cambiar
          </button>
        </div>

        <div class="security-item">
          <div class="security-icon">ğŸ“§</div>
          <div class="security-content">
            <h4>Email de Contacto</h4>
            <p>{{ currentUser.email }}</p>
          </div>
          <button class="btn btn-outline" (click)="toggleEditMode()">
            Editar
          </button>
        </div>

        <div class="security-item">
          <div class="security-icon">ğŸ“±</div>
          <div class="security-content">
            <h4>TelÃ©fono de Contacto</h4>
            <p>{{ currentUser.telefono || 'No configurado' }}</p>
          </div>
          <button class="btn btn-outline" (click)="toggleEditMode()">
            {{ currentUser.telefono ? 'Editar' : 'Configurar' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Account Actions -->
    <div *ngIf="!editMode && !changePasswordMode" class="account-actions">
      <h3>âš™ï¸ Acciones de Cuenta</h3>
      
      <div class="actions-grid">
        <div class="action-item">
          <div class="action-icon">ğŸ“Š</div>
          <div class="action-content">
            <h4>Ver Dashboard</h4>
            <p>Accede a tu panel de control principal</p>
          </div>
          <a routerLink="/cliente/dashboard" class="action-button">
            Ir al Dashboard
          </a>
        </div>

        <div class="action-item">
          <div class="action-icon">ğŸ›’</div>
          <div class="action-content">
            <h4>Mis Compras</h4>
            <p>Revisa tu historial de compras y productos</p>
          </div>
          <a routerLink="/cliente/mis-compras" class="action-button">
            Ver Compras
          </a>
        </div>

        <div class="action-item">
          <div class="action-icon">ğŸ’¬</div>
          <div class="action-content">
            <h4>Mis Comentarios</h4>
            <p>Gestiona tus comentarios y calificaciones</p>
          </div>
          <a routerLink="/cliente/comentarios" class="action-button">
            Ver Comentarios
          </a>
        </div>

        <div class="action-item">
          <div class="action-icon">ğŸ“š</div>
          <div class="action-content">
            <h4>Recursos</h4>
            <p>Accede a manuales y documentaciÃ³n</p>
          </div>
          <a routerLink="/cliente/documentacion" class="action-button">
            Ver Recursos
          </a>
        </div>
      </div>
    </div>

  </div>
</div>