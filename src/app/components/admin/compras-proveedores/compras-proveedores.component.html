<!-- src/app/components/admin/compras-proveedores/compras-proveedores.component.html -->
<div class="compras-admin">
  <div class="page-header">
    <div class="header-content">
      <h1>Compras a Proveedores</h1>
      <p>Gesti√≥n de √≥rdenes de compra y materias primas</p>
    </div>
    <div class="header-actions">
      <button (click)="openCreateModal()" class="btn btn-primary">
        ‚ûï Nueva Compra
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  @if (stats()) {
    <div class="stats-grid">
      <div class="stat-card total">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
          <h3>Total Compras</h3>
          <div class="stat-value">{{ stats()!.totalCompras }}</div>
        </div>
      </div>
      
      <div class="stat-card pending">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <h3>Pendientes</h3>
          <div class="stat-value">{{ stats()!.comprasPendientes }}</div>
        </div>
      </div>

      <div class="stat-card received">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3>Recibidas</h3>
          <div class="stat-value">{{ stats()!.comprasRecibidas }}</div>
        </div>
      </div>

      <div class="stat-card cancelled">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-content">
          <h3>Canceladas</h3>
          <div class="stat-value">{{ stats()!.comprasCanceladas }}</div>
        </div>
      </div>

      <div class="stat-card monthly">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-content">
          <h3>Este Mes</h3>
          <div class="stat-value">{{ stats()!.comprasEsteMes }}</div>
        </div>
      </div>

      <div class="stat-card expense">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <h3>Gasto Mensual</h3>
          <div class="stat-value">{{ formatCurrency(stats()!.gastoEsteMes) }}</div>
        </div>
      </div>
    </div>
  }

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-container">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          placeholder="Buscar por n√∫mero, proveedor u observaciones..."
          [value]="searchTerm()"
          (input)="onSearchChange($event)"
          class="search-input">
      </div>
      
      <div class="filter-selects">
        <select 
          [value]="selectedEstado()" 
          (change)="onEstadoChange($event)" 
          class="filter-select">
          @for (option of estadoOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>

        <select 
          [value]="selectedProveedor()" 
          (change)="onProveedorChange($event)" 
          class="filter-select">
          <option value="todos">Todos los proveedores</option>
          @for (proveedor of proveedores(); track proveedor.id) {
            <option [value]="proveedor.id">{{ proveedor.nombre }}</option>
          }
        </select>
      </div>
    </div>
  </div>

  <!-- Content -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando compras...</p>
    </div>
  } @else if (error()) {
    <div class="error-container">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Error al cargar compras</h3>
      <p>{{ error() }}</p>
      <button (click)="retry()" class="btn btn-primary">Reintentar</button>
    </div>
  } @else if (filteredCompras().length === 0) {
    <div class="empty-container">
      <div class="empty-icon">üì¶</div>
      <h3>No hay compras</h3>
      <p>No se encontraron compras que coincidan con los filtros aplicados</p>
      <button (click)="openCreateModal()" class="btn btn-primary">Crear Primera Compra</button>
    </div>
  } @else {
    <div class="compras-table">
      <div class="table-header">
        <div class="col">N√∫mero</div>
        <div class="col">Proveedor</div>
        <div class="col">Total</div>
        <div class="col">Fecha</div>
        <div class="col">Estado</div>
        <div class="col">Items</div>
        <div class="col">Acciones</div>
      </div>
      
      @for (compra of filteredCompras(); track compra.id) {
        <div class="table-row">
          <div class="col numero-compra">
            <strong>{{ compra.numeroCompra }}</strong>
            @if (compra.observaciones) {
              <small class="observaciones">üí¨ {{ compra.observaciones }}</small>
            }
          </div>
          
          <div class="col proveedor">
            {{ compra.proveedorNombre }}
          </div>
          
          <div class="col total">
            <span class="amount">{{ formatCurrency(compra.total) }}</span>
          </div>
          
          <div class="col fecha">
            {{ formatDate(compra.fechaCompra) }}
          </div>
          
          <div class="col estado">
            <span class="status-badge" [class]="getEstadoBadgeClass(compra.estado)">
              {{ compra.estado }}
            </span>
          </div>
          
          <div class="col items">
            <span class="item-count">{{ compra.cantidadItems }} items</span>
          </div>
          
          <div class="col acciones">
            <button 
              (click)="openDetailsModal(compra)"
              class="btn btn-sm btn-outline"
              title="Ver detalles">
              üëÅÔ∏è
            </button>
            
            @if (compra.estado === 'Pendiente') {
              <button 
                (click)="openEditModal(compra)"
                class="btn btn-sm btn-primary"
                title="Editar">
                ‚úèÔ∏è
              </button>
              
              <button 
                (click)="cambiarEstado(compra, 'Recibido')"
                class="btn btn-sm btn-success"
                title="Marcar como recibido">
                ‚úÖ
              </button>
              
              <button 
                (click)="cambiarEstado(compra, 'Cancelado')"
                class="btn btn-sm btn-warning"
                title="Cancelar">
                ‚ùå
              </button>
            }
            
            @if (compra.estado === 'Cancelado' || compra.estado === 'Pendiente') {
              <button 
                (click)="deleteCompra(compra)"
                class="btn btn-sm btn-danger"
                title="Eliminar">
                üóëÔ∏è
              </button>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Create Modal -->
  @if (showCreateModal()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nueva Compra a Proveedor</h2>
          <button (click)="closeCreateModal()" class="close-btn">‚úï</button>
        </div>
        
        <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-group">
                <label for="proveedor">Proveedor *</label>
                <select
                  id="proveedor"
                  formControlName="proveedorId"
                  class="form-control">
                  <option value="">Seleccionar proveedor</option>
                  @for (proveedor of proveedores(); track proveedor.id) {
                    <option [value]="proveedor.id">{{ proveedor.nombre }}</option>
                  }
                </select>
                @if (createForm.get('proveedorId')?.errors && createForm.get('proveedorId')?.touched) {
                  <div class="error-message">El proveedor es requerido</div>
                }
              </div>

              <div class="form-group">
                <label for="fechaCompra">Fecha de Compra *</label>
                <input
                  id="fechaCompra"
                  type="date"
                  formControlName="fechaCompra"
                  class="form-control">
                @if (createForm.get('fechaCompra')?.errors && createForm.get('fechaCompra')?.touched) {
                  <div class="error-message">La fecha es requerida</div>
                }
              </div>

              <div class="form-group full-width">
                <label for="observaciones">Observaciones</label>
                <textarea
                  id="observaciones"
                  formControlName="observaciones"
                  class="form-control"
                  rows="3"
                  placeholder="Observaciones adicionales sobre la compra"></textarea>
              </div>
            </div>

            <!-- Detalles de la Compra -->
            <div class="detalles-section">
              <div class="detalles-header">
                <h3>Detalles de la Compra</h3>
                <button type="button" (click)="addDetalle('create')" class="btn btn-sm btn-success">
                  ‚ûï Agregar Item
                </button>
              </div>

              <!-- ‚úÖ VERIFICACI√ìN M√ÅS ESTRICTA -->
              @if (createDetalles && createDetalles.length > 0 && createDetalles.controls) {
                <div class="detalles-table">
                  @for (detalle of createDetalles.controls; track $index; let i = $index) {
                    @if (detalle && detalle.get('materiaPrimaId') && detalle.get('cantidad') && detalle.get('precioUnitario')) {
                      <div class="detalle-row" [formGroupName]="i">
                        <div class="detalle-field">
                          <label>Materia Prima *</label>
                          <select formControlName="materiaPrimaId" class="form-control">
                            <option value="">Seleccionar</option>
                            @for (mp of materiasPrimas(); track mp.id) {
                              <option [value]="mp.id">{{ mp.nombre }}</option>
                            }
                          </select>
                        </div>

                        <div class="detalle-field">
                          <label>Cantidad *</label>
                          <input type="number" formControlName="cantidad" class="form-control" min="1">
                        </div>

                        <div class="detalle-field">
                          <label>Precio Unitario *</label>
                          <input type="number" formControlName="precioUnitario" class="form-control" min="0.01" step="0.01">
                        </div>

                        <div class="detalle-field">
                          <label>Subtotal</label>
                          <div class="subtotal-display">
                            {{ formatCurrency(calculateSubtotal(detalle.get('cantidad')?.value || 0, detalle.get('precioUnitario')?.value || 0)) }}
                          </div>
                        </div>

                        <div class="detalle-actions">
                          <button type="button" (click)="removeDetalle('create', i)" class="btn btn-sm btn-danger">
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    }
                  }
                </div>
              }

              @if (createDetalles.length === 0) {
                <div class="no-detalles">
                  <p>No hay items agregados</p>
                  <button type="button" (click)="addDetalle('create')" class="btn btn-primary">
                    ‚ûï Agregar Primer Item
                  </button>
                </div>
              }

              @if (createDetalles.length > 0) {
                <div class="total-section">
                  <div class="total-row">
                    <strong>Total: {{ formatCurrency(calculateTotal('create')) }}</strong>
                  </div>
                </div>
              }
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" (click)="closeCreateModal()" class="btn btn-outline">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!createForm.valid || submitting()">
              @if (submitting()) {
                <span class="spinner-sm"></span>
              }
              Crear Compra
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Edit Modal -->
  @if (showEditModal() && selectedCompra()) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Editar Compra: {{ selectedCompra()!.numeroCompra }}</h2>
          <button (click)="closeEditModal()" class="close-btn">‚úï</button>
        </div>
        
        <form [formGroup]="editForm" (ngSubmit)="submitEdit()">
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-group">
                <label for="editProveedor">Proveedor *</label>
                <select
                  id="editProveedor"
                  formControlName="proveedorId"
                  class="form-control">
                  @for (proveedor of proveedores(); track proveedor.id) {
                    <option [value]="proveedor.id">{{ proveedor.nombre }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="editFechaCompra">Fecha de Compra *</label>
                <input
                  id="editFechaCompra"
                  type="date"
                  formControlName="fechaCompra"
                  class="form-control">
              </div>

              <div class="form-group full-width">
                <label for="editObservaciones">Observaciones</label>
                <textarea
                  id="editObservaciones"
                  formControlName="observaciones"
                  class="form-control"
                  rows="3"></textarea>
              </div>
            </div>

            <!-- Detalles de la Compra -->
            <div class="detalles-section">
              <div class="detalles-header">
                <h3>Detalles de la Compra</h3>
                <button type="button" (click)="addDetalle('edit')" class="btn btn-sm btn-success">
                  ‚ûï Agregar Item
                </button>
              </div>

              <!-- ‚úÖ VERIFICACI√ìN M√ÅS ESTRICTA PARA EDIT -->
              @if (editDetalles && editDetalles.length > 0 && editDetalles.controls) {
                <div class="detalles-table">
                  @for (detalle of editDetalles.controls; track $index; let i = $index) {
                    @if (detalle && detalle.get('materiaPrimaId') && detalle.get('cantidad') && detalle.get('precioUnitario')) {
                      <div class="detalle-row" [formGroupName]="i">
                        <div class="detalle-field">
                          <label>Materia Prima *</label>
                          <select formControlName="materiaPrimaId" class="form-control">
                            @for (mp of materiasPrimas(); track mp.id) {
                              <option [value]="mp.id">{{ mp.nombre }}</option>
                            }
                          </select>
                        </div>

                        <div class="detalle-field">
                          <label>Cantidad *</label>
                          <input type="number" formControlName="cantidad" class="form-control" min="1">
                        </div>

                        <div class="detalle-field">
                          <label>Precio Unitario *</label>
                          <input type="number" formControlName="precioUnitario" class="form-control" min="0.01" step="0.01">
                        </div>

                        <div class="detalle-field">
                          <label>Subtotal</label>
                          <div class="subtotal-display">
                            {{ formatCurrency(calculateSubtotal(detalle.get('cantidad')?.value || 0, detalle.get('precioUnitario')?.value || 0)) }}
                          </div>
                        </div>

                        <div class="detalle-actions">
                          <button type="button" (click)="removeDetalle('edit', i)" class="btn btn-sm btn-danger">
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    }
                  }
                </div>
              }

              @if (editDetalles.length > 0) {
                <div class="total-section">
                  <div class="total-row">
                    <strong>Total: {{ formatCurrency(calculateTotal('edit')) }}</strong>
                  </div>
                </div>
              }
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" (click)="closeEditModal()" class="btn btn-outline">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!editForm.valid || submitting()">
              @if (submitting()) {
                <span class="spinner-sm"></span>
              }
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Details Modal -->
  @if (showDetailsModal() && selectedCompra()) {
    <div class="modal-overlay" (click)="closeDetailsModal()">
      <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ selectedCompra()!.numeroCompra }}</h2>
          <button (click)="closeDetailsModal()" class="close-btn">‚úï</button>
        </div>
        
        <div class="modal-body">
          <div class="compra-details">
            <div class="details-section">
              <h3>Informaci√≥n General</h3>
              <div class="details-grid">
                <div class="detail-item">
                  <label>N√∫mero de Compra:</label>
                  <span>{{ selectedCompra()!.numeroCompra }}</span>
                </div>
                <div class="detail-item">
                  <label>Proveedor:</label>
                  <span>{{ selectedCompra()!.proveedorNombre }}</span>
                </div>
                <div class="detail-item">
                  <label>Fecha de Compra:</label>
                  <span>{{ formatDate(selectedCompra()!.fechaCompra) }}</span>
                </div>
                <div class="detail-item">
                  <label>Estado:</label>
                  <span class="status-badge" [class]="getEstadoBadgeClass(selectedCompra()!.estado)">
                    {{ selectedCompra()!.estado }}
                  </span>
                </div>
                <div class="detail-item">
                  <label>Total:</label>
                  <span class="amount-large">{{ formatCurrency(selectedCompra()!.total) }}</span>
                </div>
                @if (selectedCompra()!.observaciones) {
                  <div class="detail-item full-width">
                    <label>Observaciones:</label>
                    <span>{{ selectedCompra()!.observaciones }}</span>
                  </div>
                }
              </div>
            </div>

            <div class="details-section">
              <h3>Detalles de Items ({{ selectedCompra()!.detalles?.length || 0 }} items)</h3>
              @if (selectedCompra()!.detalles?.length) {
                <div class="detalles-table-view">
                  <div class="detalles-header-view">
                    <div class="col">Materia Prima</div>
                    <div class="col">Cantidad</div>
                    <div class="col">Precio Unit.</div>
                    <div class="col">Subtotal</div>
                  </div>
                  @for (detalle of selectedCompra()!.detalles; track detalle.id) {
                    <div class="detalles-row-view">
                      <div class="col">{{ detalle.materiaPrimaNombre }}</div>
                      <div class="col">{{ detalle.cantidad }}</div>
                      <div class="col">{{ formatCurrency(detalle.precioUnitario) }}</div>
                      <div class="col">{{ formatCurrency(detalle.subtotal) }}</div>
                    </div>
                  }
                  <div class="detalles-total-view">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"><strong>Total:</strong></div>
                    <div class="col"><strong>{{ formatCurrency(selectedCompra()!.total) }}</strong></div>
                  </div>
                </div>
              } @else {
                <div class="no-data">Sin detalles disponibles</div>
              }
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          @if (selectedCompra()!.estado === 'Pendiente') {
            <button (click)="openEditModal(selectedCompra()!)" class="btn btn-primary">
              ‚úèÔ∏è Editar Compra
            </button>
          }
          <button (click)="closeDetailsModal()" class="btn btn-outline">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }
</div>