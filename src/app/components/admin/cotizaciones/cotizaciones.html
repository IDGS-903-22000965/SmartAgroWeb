<div class="cotizaciones-container">
    <div class="header-section">
    <h1>Gesti√≥n de Cotizaciones</h1>
    <div class="stats-grid">
      <div class="stat-card">
        <h3>{{ contarPendientes() }}</h3>
        <p>Pendientes</p>
      </div>
      <div class="stat-card">
        <h3>{{ contarAprobadas() }}</h3>
        <p>Aprobadas</p>
      </div>
      <div class="stat-card">
        <h3>{{ contarExpiradas() }}</h3>
        <p>Expiradas</p>
      </div>
    </div>
  </div>

    <div class="filters-section">
    <div class="filter-group">
      <label>Estado:</label>
      <select (change)="onEstadoChange($event)" [value]="selectedEstado()">
        <option 
          *ngFor="let option of estadoOptions; trackBy: trackByValue" 
          [value]="option.value">
          {{ option.label }}
        </option>
      </select>
    </div>

    <div class="filter-group">
      <label>B√∫squeda:</label>
      <input 
        type="text" 
        placeholder="Buscar por n√∫mero, cliente, email..."
        (input)="onSearchChange($event)"
        [value]="searchTerm()">
    </div>

    <div class="filter-group">
      <label>Fecha:</label>
      <select (change)="onDateRangeChange($event)" [value]="selectedDateRange()">
        <option 
          *ngFor="let option of dateRangeOptions; trackBy: trackByValue" 
          [value]="option.value">
          {{ option.label }}
        </option>
      </select>
    </div>

    <button class="btn btn-secondary" (click)="exportToCSV()">
      Exportar CSV
    </button>
  </div>

    <div *ngIf="loading()" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando cotizaciones...</p>
  </div>

    <div *ngIf="error()" class="error-state">
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="retry()">Reintentar</button>
  </div>

    <div *ngIf="!loading() && !error()" class="cotizaciones-list">
    <div *ngIf="filteredCotizaciones().length === 0" class="empty-state">
      <p>No se encontraron cotizaciones con los filtros aplicados.</p>
    </div>

    <div class="cotizacion-card" *ngFor="let cotizacion of filteredCotizaciones()">
      <div class="card-header">
        <div class="cotizacion-info">
          <h3>{{ cotizacion.numeroCotizacion }}</h3>
          <span class="badge" [class]="'badge-' + getEstadoColor(cotizacion.estado)">
            {{ cotizacion.estado }}
          </span>
        </div>
        <div class="cotizacion-date">
          {{ formatDate(cotizacion.fechaCotizacion) }}
        </div>
      </div>

      <div class="card-body">
        <div class="client-info">
          <p><strong>Cliente:</strong> {{ cotizacion.nombreCliente }}</p>
          <p><strong>Email:</strong> {{ cotizacion.emailCliente }}</p>
          <p><strong>Cultivo:</strong> {{ cotizacion.tipoCultivo }}</p>
          <p><strong>√Årea:</strong> {{ cotizacion.areaCultivo }} m¬≤</p>
        </div>

        <div class="cotizacion-summary">
          <p><strong>Total:</strong> {{ formatCurrency(cotizacion.total) }}</p>
          <p *ngIf="!isExpired(cotizacion)">
            <strong>Vence en:</strong> {{ getDaysUntilExpiration(cotizacion) }} d√≠as
          </p>
          <p *ngIf="isExpired(cotizacion)" class="text-danger">
            <strong>‚ö†Ô∏è Expirada</strong>
          </p>
        </div>
      </div>

      <div class="card-actions">
        <button 
          class="btn btn-outline-primary" 
          (click)="openDetailsModal(cotizacion)">
          Ver Detalles
        </button>

                <div class="action-buttons">
                    <ng-container *ngIf="cotizacion.estado === 'Pendiente' && !isExpired(cotizacion)">
            <button 
              class="btn btn-success" 
              (click)="updateEstado(cotizacion, 'Aprobada')"
              [disabled]="updatingStatus()">
              {{ updatingStatus() ? 'Procesando...' : 'Aprobar' }}
            </button>
            <button 
              class="btn btn-danger" 
              (click)="updateEstado(cotizacion, 'Rechazada')"
              [disabled]="updatingStatus()">
              Rechazar
            </button>
          </ng-container>

                    <ng-container *ngIf="canConvertToSale(cotizacion)">
            <button 
              class="btn btn-primary" 
              (click)="openConvertModal(cotizacion)">
              üõí Convertir a Venta
            </button>
          </ng-container>

                    <ng-container *ngIf="isAlreadySold(cotizacion)">
            <span class="badge badge-info">‚úÖ Ya convertida a venta</span>
          </ng-container>

                    <ng-container *ngIf="isExpired(cotizacion)">
            <span class="badge badge-secondary">‚ö†Ô∏è Expirada</span>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showConvertModal()" class="modal-overlay" (click)="closeConvertModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Convertir Cotizaci√≥n a Venta</h2>
      <button class="close-btn" (click)="closeConvertModal()">√ó</button>
    </div>

    <div class="modal-body" *ngIf="selectedCotizacion()">
      <div class="cotizacion-summary">
        <h3>{{ selectedCotizacion()?.numeroCotizacion }}</h3>
        <p><strong>Cliente:</strong> {{ selectedCotizacion()?.nombreCliente }}</p>
        <p><strong>Total:</strong> {{ formatCurrency(selectedCotizacion()?.total || 0) }}</p>
      </div>

      <form #convertForm="ngForm" (ngSubmit)="convertToSale(metodoPago.value, direccionEntrega.value, observaciones.value)">
        <div class="form-group">
          <label for="metodoPago">M√©todo de Pago *</label>
          <select 
            #metodoPago 
            id="metodoPago" 
            required 
            class="form-control">
            <option value="">Seleccione m√©todo de pago</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option>
            <option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option>
            <option value="Transferencia">Transferencia Bancaria</option>
            <option value="Cheque">Cheque</option>
          </select>
        </div>

        <div class="form-group">
          <label for="direccionEntrega">Direcci√≥n de Entrega</label>
          <textarea 
            #direccionEntrega 
            id="direccionEntrega" 
            class="form-control"
            rows="3"
            [placeholder]="'Por defecto: ' + selectedCotizacion()?.direccionInstalacion"></textarea>
          <small class="form-text text-muted">
            Deje vac√≠o para usar la direcci√≥n de instalaci√≥n de la cotizaci√≥n
          </small>
        </div>

        <div class="form-group">
          <label for="observaciones">Observaciones</label>
          <textarea 
            #observaciones 
            id="observaciones" 
            class="form-control"
            rows="3"
            placeholder="Observaciones adicionales (opcional)"></textarea>
        </div>

        <div class="modal-actions">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeConvertModal()">
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="!convertForm.valid || convertingToSale()">
            {{ convertingToSale() ? 'Creando Venta...' : 'Crear Venta' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div *ngIf="showDetailsModal()" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Detalles de Cotizaci√≥n</h2>
      <button class="close-btn" (click)="closeDetailsModal()">√ó</button>
    </div>

    <div class="modal-body" *ngIf="selectedCotizacion()">
            <div class="details-grid">
        <div class="detail-section">
          <h3>Informaci√≥n del Cliente</h3>
          <p><strong>Nombre:</strong> {{ selectedCotizacion()?.nombreCliente }}</p>
          <p><strong>Email:</strong> {{ selectedCotizacion()?.emailCliente }}</p>
          <p><strong>Tel√©fono:</strong> {{ selectedCotizacion()?.telefonoCliente || 'No proporcionado' }}</p>
        </div>

        <div class="detail-section">
          <h3>Informaci√≥n del Proyecto</h3>
          <p><strong>Direcci√≥n:</strong> {{ selectedCotizacion()?.direccionInstalacion }}</p>
          <p><strong>Tipo de Cultivo:</strong> {{ selectedCotizacion()?.tipoCultivo }}</p>
          <p><strong>√Årea:</strong> {{ selectedCotizacion()?.areaCultivo }} m¬≤</p>
          <p><strong>Tipo de Suelo:</strong> {{ selectedCotizacion()?.tipoSuelo }}</p>
        </div>

        <div class="detail-section">
          <h3>Recursos Disponibles</h3>
          <p><strong>Fuente de Agua:</strong> {{ selectedCotizacion()?.fuenteAguaDisponible ? 'S√≠' : 'No' }}</p>
          <p><strong>Energ√≠a El√©ctrica:</strong> {{ selectedCotizacion()?.energiaElectricaDisponible ? 'S√≠' : 'No' }}</p>
        </div>

        <div class="detail-section">
          <h3>Informaci√≥n Financiera</h3>
          <p><strong>Subtotal:</strong> {{ formatCurrency(selectedCotizacion()?.subtotal || 0) }}</p>
          <p><strong>Impuestos:</strong> {{ formatCurrency(selectedCotizacion()?.impuestos || 0) }}</p>
          <p><strong>Total:</strong> {{ formatCurrency(selectedCotizacion()?.total || 0) }}</p>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedCotizacion()?.requerimientosEspeciales">
        <h3>Requerimientos Especiales</h3>
        <p>{{ selectedCotizacion()?.requerimientosEspeciales }}</p>
      </div>
    </div>
  </div>
</div>