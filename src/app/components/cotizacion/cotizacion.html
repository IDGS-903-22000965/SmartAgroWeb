<!-- src/app/components/cotizacion/cotizacion.html -->
<div class="cotizacion-page">
  @if (success()) {
    <!-- Success State -->
    <div class="success-container">
      <div class="success-content">
        <div class="success-icon">‚úÖ</div>
        <h1>¬°Cotizaci√≥n Enviada Exitosamente!</h1>
        <p>
          Hemos recibido tu solicitud de cotizaci√≥n. Nuestro equipo de expertos 
          la revisar√° y se pondr√° en contacto contigo en las pr√≥ximas 24 horas.
        </p>
        
        <div class="success-details">
          <div class="detail-item">
            <span class="detail-icon">üìß</span>
            <span>Recibir√°s un email de confirmaci√≥n</span>
          </div>
          <div class="detail-item">
            <span class="detail-icon">üìû</span>
            <span>Te contactaremos en menos de 24 horas</span>
          </div>
          <div class="detail-item">
            <span class="detail-icon">üí°</span>
            <span>Propuesta personalizada para tu proyecto</span>
          </div>
        </div>

        <div class="success-actions">
          <button (click)="goHome()" class="btn btn-primary">
            Volver al Inicio
          </button>
          <button (click)="resetForm()" class="btn btn-outline">
            Nueva Cotizaci√≥n
          </button>
        </div>
      </div>
    </div>
  } @else {
    <!-- Form State -->
    <div class="cotizacion-container">
      <!-- Header -->
      <div class="cotizacion-header">
        <div class="container">
          <h1>Solicitar Cotizaci√≥n</h1>
          <p>Completa el formulario y recibe una propuesta personalizada para tu proyecto</p>
          
          <!-- Progress Bar -->
          <div class="progress-container">
            <div class="progress-bar">
              @for (step of [1,2,3,4]; track step) {
                <div 
                  class="progress-step"
                  [class.active]="currentStep() === step"
                  [class.completed]="currentStep() > step"
                  (click)="goToStep(step)">
                  <div class="step-number">{{ step }}</div>
                  <div class="step-label">
                    @switch (step) {
                      @case (1) { Informaci√≥n Personal }
                      @case (2) { Proyecto }
                      @case (3) { Recursos }
                      @case (4) { Finalizar }
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Form Content -->
      <div class="cotizacion-content">
        <div class="container">
          <form [formGroup]="cotizacionForm" class="cotizacion-form">
            @if (error()) {
              <div class="alert alert-error">
                <span class="alert-icon">‚ö†Ô∏è</span>
                {{ error() }}
              </div>
            }

            <!-- Step 1: Informaci√≥n Personal -->
            @if (currentStep() === 1) {
              <div class="form-step">
                <div class="step-header">
                  <h2>Informaci√≥n Personal</h2>
                  <p>Cu√©ntanos sobre ti y tu proyecto</p>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label for="nombreCliente" class="form-label">Nombre Completo *</label>
                    <input
                      type="text"
                      id="nombreCliente"
                      formControlName="nombreCliente"
                      class="form-input"
                      [class.error]="isFieldInvalid('nombreCliente')"
                      placeholder="Tu nombre completo">
                    @if (getFieldError('nombreCliente')) {
                      <span class="field-error">{{ getFieldError('nombreCliente') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="emailCliente" class="form-label">Email *</label>
                    <input
                      type="email"
                      id="emailCliente"
                      formControlName="emailCliente"
                      class="form-input"
                      [class.error]="isFieldInvalid('emailCliente')"
                      placeholder="tu@email.com">
                    @if (getFieldError('emailCliente')) {
                      <span class="field-error">{{ getFieldError('emailCliente') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="telefonoCliente" class="form-label">Tel√©fono</label>
                    <input
                      type="tel"
                      id="telefonoCliente"
                      formControlName="telefonoCliente"
                      class="form-input"
                      [class.error]="isFieldInvalid('telefonoCliente')"
                      placeholder="1234567890">
                    @if (getFieldError('telefonoCliente')) {
                      <span class="field-error">{{ getFieldError('telefonoCliente') }}</span>
                    }
                  </div>
                </div>
              </div>
            }

            <!-- Step 2: Informaci√≥n del Proyecto -->
            @if (currentStep() === 2) {
              <div class="form-step">
                <div class="step-header">
                  <h2>Informaci√≥n del Proyecto</h2>
                  <p>Detalles sobre tu cultivo y ubicaci√≥n</p>
                </div>

                <div class="form-grid">
                  <div class="form-group full-width">
                    <label for="direccionInstalacion" class="form-label">Direcci√≥n de Instalaci√≥n *</label>
                    <input
                      type="text"
                      id="direccionInstalacion"
                      formControlName="direccionInstalacion"
                      class="form-input"
                      [class.error]="isFieldInvalid('direccionInstalacion')"
                      placeholder="Direcci√≥n completa donde se instalar√° el sistema">
                    @if (getFieldError('direccionInstalacion')) {
                      <span class="field-error">{{ getFieldError('direccionInstalacion') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="areaCultivo" class="form-label">√Årea de Cultivo (m¬≤) *</label>
                    <input
                      type="number"
                      id="areaCultivo"
                      formControlName="areaCultivo"
                      class="form-input"
                      [class.error]="isFieldInvalid('areaCultivo')"
                      placeholder="100"
                      min="1"
                      max="10000">
                    @if (getFieldError('areaCultivo')) {
                      <span class="field-error">{{ getFieldError('areaCultivo') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="tipoCultivo" class="form-label">Tipo de Cultivo *</label>
                    <select
                      id="tipoCultivo"
                      formControlName="tipoCultivo"
                      class="form-select"
                      [class.error]="isFieldInvalid('tipoCultivo')">
                      <option value="">Selecciona el tipo de cultivo</option>
                      @for (tipo of tiposCultivo; track tipo) {
                        <option [value]="tipo">{{ tipo }}</option>
                      }
                    </select>
                    @if (getFieldError('tipoCultivo')) {
                      <span class="field-error">{{ getFieldError('tipoCultivo') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="tipoSuelo" class="form-label">Tipo de Suelo *</label>
                    <select
                      id="tipoSuelo"
                      formControlName="tipoSuelo"
                      class="form-select"
                      [class.error]="isFieldInvalid('tipoSuelo')">
                      <option value="">Selecciona el tipo de suelo</option>
                      @for (tipo of tiposSuelo; track tipo) {
                        <option [value]="tipo">{{ tipo }}</option>
                      }
                    </select>
                    @if (getFieldError('tipoSuelo')) {
                      <span class="field-error">{{ getFieldError('tipoSuelo') }}</span>
                    }
                  </div>
                </div>
              </div>
            }

            <!-- Step 3: Recursos Disponibles -->
            @if (currentStep() === 3) {
              <div class="form-step">
                <div class="step-header">
                  <h2>Recursos Disponibles</h2>
                  <p>Informaci√≥n sobre agua y energ√≠a en tu ubicaci√≥n</p>
                </div>

                <div class="resources-grid">
                  <div class="resource-card">
                    <div class="resource-icon">üíß</div>
                    <div class="resource-content">
                      <h3>Fuente de Agua</h3>
                      <p>¬øTienes acceso directo a fuente de agua en el √°rea de cultivo?</p>
                      <label class="checkbox-container">
                        <input 
                          type="checkbox" 
                          formControlName="fuenteAguaDisponible"
                          class="checkbox-input">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label">S√≠, tengo acceso a fuente de agua</span>
                      </label>
                    </div>
                  </div>

                  <div class="resource-card">
                    <div class="resource-icon">‚ö°</div>
                    <div class="resource-content">
                      <h3>Energ√≠a El√©ctrica</h3>
                      <p>¬øHay suministro el√©ctrico disponible en el √°rea de instalaci√≥n?</p>
                      <label class="checkbox-container">
                        <input 
                          type="checkbox" 
                          formControlName="energiaElectricaDisponible"
                          class="checkbox-input">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label">S√≠, hay energ√≠a el√©ctrica disponible</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div class="info-note">
                  <div class="note-icon">üí°</div>
                  <div class="note-content">
                    <h4>Nota Importante</h4>
                    <p>
                      Si no cuentas con alguno de estos recursos, nuestro equipo incluir√° 
                      las soluciones necesarias en tu cotizaci√≥n (bomba de agua, sistema solar, etc.).
                    </p>
                  </div>
                </div>
              </div>
            }

            <!-- Step 4: Requerimientos Especiales y Finalizar -->
            @if (currentStep() === 4) {
              <div class="form-step">
                <div class="step-header">
                  <h2>Requerimientos Especiales</h2>
                  <p>Detalles adicionales sobre tu proyecto</p>
                </div>

                <div class="form-group">
                  <label for="requierimientosEspeciales" class="form-label">
                    Requerimientos Especiales (Opcional)
                  </label>
                  <textarea
                    id="requierimientosEspeciales"
                    formControlName="requierimientosEspeciales"
                    class="form-textarea"
                    placeholder="Describe cualquier requerimiento especial, caracter√≠sticas adicionales que necesites, o informaci√≥n relevante para tu proyecto..."
                    rows="4"></textarea>
                </div>

                <!-- Cost Estimation -->
                <div class="cost-estimation">
                  <h3>Estimaci√≥n de Costo</h3>
                  <p>Calcula una estimaci√≥n preliminar basada en la informaci√≥n proporcionada</p>
                  
                  <button 
                    type="button"
                    (click)="calculateCost()"
                    class="btn btn-outline"
                    [disabled]="calculating()">
                    @if (calculating()) {
                      <span class="btn-spinner"></span>
                      Calculando...
                    } @else {
                      Calcular Estimaci√≥n
                    }
                  </button>

                  @if (estimatedCost()) {
                    <div class="cost-result">
                      <div class="cost-item">
                        <span class="cost-label">Costo estimado:</span>
                        <span class="cost-value">${{ estimatedCost() | number:'1.2-2' }}</span>
                      </div>
                      <div class="cost-item">
                        <span class="cost-label">Con IVA (16%):</span>
                        <span class="cost-value total">${{ estimatedCostWithTax() | number:'1.2-2' }}</span>
                      </div>
                      <div class="cost-note">
                        <small>*Esta es una estimaci√≥n preliminar. El costo final puede variar seg√∫n los requerimientos espec√≠ficos.</small>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Navigation Buttons -->
            <div class="form-navigation">
              @if (currentStep() > 1) {
                <button 
                  type="button" 
                  (click)="prevStep()" 
                  class="btn btn-outline">
                  ‚Üê Anterior
                </button>
              }

              <div class="nav-spacer"></div>

              @if (currentStep() < totalSteps) {
                <button 
                  type="button" 
                  (click)="nextStep()" 
                  class="btn btn-primary">
                  Siguiente ‚Üí
                </button>
              } @else {
                <button 
                  type="button" 
                  (click)="submitCotizacion()" 
                  class="btn btn-primary"
                  [disabled]="loading()">
                  @if (loading()) {
                    <span class="btn-spinner"></span>
                    Enviando...
                  } @else {
                    Enviar Cotizaci√≥n
                  }
                </button>
              }
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>